<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å¿†ç¼–ç»‡è€… (Weaver)</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f0f2f5;
        }
        .hero-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background-color: #5a67d8;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #4c51bf;
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4c51bf;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            border: 1px solid #cbd5e0;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0;
        }
        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .tag {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.875rem;
            margin-right: 8px;
            margin-bottom: 8px;
            display: inline-block;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        .streamed-narrative-container {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 350px;
            overflow-y: auto;
            line-height: 1.8;
            color: #374151;
        }
        .streamed-narrative-container p {
            margin-bottom: 1rem;
        }
        .highlighted-text-segment {
            background-color: #e0e7ff;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .narrative-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        .narrative-text-content {
            flex-basis: 30%;
            flex-shrink: 0;
        }
        .generated-image-container {
            flex-basis: 70%;
            flex-shrink: 0;
            height: 256px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #cbd5e0;
            border-radius: 8px;
            background-color: #f8fafc;
            overflow: hidden;
        }
        .generated-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .image-generation-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
        }

        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 0.875rem; color: #4c51bf; margin-left: 0.5rem; }

        .tab-navigation button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: #4a5568;
            border-bottom: 2px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .tab-navigation button.active {
            color: #5a67d8;
            border-bottom-color: #5a67d8;
        }
        .tab-navigation button:hover:not(.active) {
            color: #2d3748;
        }
        .interactive-prompt-input {
            transition: width 0.3s ease-in-out;
        }

        /* Floating Video Player Styles */
        #floating-video-player {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px); /* Start off-screen for slide-up effect */
        }
        #floating-video-player.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- START: Multimedia Album Styles --- */
        #multimedia-album-section {
            /* Uses .card styles */
        }
        #album-content-area {
            transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 0; /* Initially collapsed */
            opacity: 0;
            margin-top: 1rem; /* Space below the toggle button */
        }
        #album-content-area.expanded {
            max-height: 1000px; /* Adjust as needed to fit content */
            opacity: 1;
        }
        #album-item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Slightly smaller items */
            gap: 1rem;
            padding-top: 0.5rem; /* Reduced padding */
        }
        .note-component, .image-component {
            background-color: #f9fafb; /* Tailwind gray-50 */
            border: 1px solid #e5e7eb; /* Tailwind gray-200 */
            border-radius: 8px;
            padding: 0.75rem; /* Reduced padding */
            text-align: center;
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #4b5563; /* Tailwind gray-600 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px; /* Ensure some consistent height */
        }
        .note-component h5, .image-component h5 {
            font-weight: 600; /* Tailwind font-semibold */
            margin-bottom: 0.5rem;
            color: #1f2937; /* Tailwind gray-800 */
            font-size: 0.875rem;
        }
        .note-component p, .image-component p {
            line-height: 1.5;
            font-size: 0.8rem; /* Slightly smaller text for content */
            word-break: break-word;
        }
        .img-placeholder {
            font-size: 2.5rem; /* Icon size */
            color: #9ca3af; /* Tailwind gray-400 */
            margin-bottom: 0.5rem;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .album-toggle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.6rem 1rem;
            font-weight: 500;
            color: #4c51bf; /* Tailwind indigo-700 */
            background-color: #e0e7ff; /* Tailwind indigo-100 */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9rem;
        }
        .album-toggle-button:hover {
            background-color: #c7d2fe; /* Tailwind indigo-200 */
        }
        .album-toggle-button .fas {
            margin-left: 0.75rem;
            transition: transform 0.3s ease;
        }
        .album-toggle-button.expanded .fas {
            transform: rotate(180deg);
        }
        /* --- END: Multimedia Album Styles --- */

    </style>
</head>
<body>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">è®°å¿†ç¼–ç»‡è€… (Weaver)</h1>
            <span class="text-sm text-gray-600">è®©æ¯ä¸€æ®µæ—…ç¨‹éƒ½æˆä¸ºä¼ å¥‡</span>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">

        <section class="mb-12 text-center p-8 hero-bg text-white rounded-xl shadow-lg">
            <h2 class="text-4xl font-bold mb-4">é‡å¡‘æ‚¨çš„æ—…è¡Œè®°å¿†</h2>
            <p class="text-lg max-w-3xl mx-auto">
                è¿ç”¨å¯Œæœ‰åˆ›é€ åŠ›çš„ LLM Agents ä¸æ´æ‚‰ä¸‡å…³è”çš„çŸ¥è¯†å›¾è°±ï¼Œå°†æ‚¨æ¯ä¸€æ¬¡æ—…è¡Œä¸­æ•æ‰çš„å¤šæ¨¡æ€ç¬é—´â€”â€”æ— è®ºæ˜¯å½±åƒã€å£°éŸ³è¿˜æ˜¯æ–‡å­—æ„Ÿæ‚Ÿâ€”â€”ä»é›¶æ•£çš„ç‰‡æ®µå‡åä¸ºä¸€æ®µæ®µç‹¬ä¸€æ— äºŒã€é¥±å«æƒ…æ„Ÿçš„æ•°å­—è®°å¿†ä¼ å¥‡ã€‚
            </p>
        </section>

        <div class="mb-8 tab-navigation flex justify-center border-b border-gray-300">
            <button id="tab-add-memory" type="button">æ·»åŠ æ–°çš„è®°å¿†</button>
            <button id="tab-weave-results" type="button">ç¼–ç»‡æ–°çš„å›å¿†</button>
        </div>

        <div id="tab-content-area">
            <section id="upload-section" class="mb-12">
                <h2 class="section-title">å¼€å§‹æ–°çš„è®°å¿†ç¼–ç»‡</h2>
                <div class="card p-8">
                    <form id="memory-form">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="trip-name" class="block text-sm font-medium text-gray-700 mb-1">æ—…ç¨‹åç§°</label>
                                <input type="text" id="trip-name" name="trip-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šäº¬éƒ½ç§‹æ—¥ç§è¯­">
                            </div>
                            <div>
                                <label for="trip-start-date" class="block text-sm font-medium text-gray-700 mb-1">æ—…è¡Œå¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="trip-start-date" name="trip-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                 <label for="trip-end-date" class="block text-sm font-medium text-gray-700 mb-1">æ—…è¡Œç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="trip-end-date" name="trip-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="memory-location" class="block text-sm font-medium text-gray-700 mb-1">åœ°ç‚¹æ ‡è®°</label>
                                <input type="text" id="memory-location" name="memory-location" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ¸…æ°´å¯º, äº¬éƒ½, æ—¥æœ¬">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="memory-text" class="block text-sm font-medium text-gray-700 mb-1">æ–‡å­—æ„Ÿæ‚Ÿ/ç¬”è®° (æ‰‹åŠ¨è¾“å…¥)</label>
                            <textarea id="memory-text" name="memory-text" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="è®°å½•ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…ã€æœ‰è¶£çš„è§é—»..."></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="memory-notes-file" class="block text-sm font-medium text-gray-700 mb-1">ä¸Šä¼ æ–‡å­—æ„Ÿæ‚Ÿæ–‡ä»¶ (æ¨è .txt, .md)</label>
                            <input type="file" id="memory-notes-file" name="memory-notes-file" accept=".txt,.md" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                             <p class="text-xs text-gray-500 mt-1">å¦‚æœåŒæ—¶æä¾›äº†æ‰‹åŠ¨è¾“å…¥å’Œæ–‡ä»¶ï¼Œå°†ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶å†…å®¹ã€‚</p>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="memory-photos" class="block text-sm font-medium text-gray-700 mb-1">ä¸Šä¼ ç…§ç‰‡/è§†é¢‘ (æ¦‚å¿µ)</label>
                                <input type="file" id="memory-photos" name="memory-photos" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                <p class="text-xs text-gray-500 mt-1">é€‰æ‹©æ‚¨æƒ³è¦ç¼–ç»‡çš„ç…§ç‰‡æˆ–è§†é¢‘ç‰‡æ®µã€‚</p>
                            </div>
                            <div>
                                <label for="memory-music" class="block text-sm font-medium text-gray-700 mb-1">å½“æ—¶å¬çš„éŸ³ä¹ (å¯é€‰)</label>
                                <input type="text" id="memory-music" name="memory-music" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ä¾‹å¦‚ï¼šå‚æœ¬é¾™ä¸€ - Merry Christmas Mr. Lawrence">
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="button" id="weave-button" class="btn-primary text-lg px-8 py-3">
                                å¼€å§‹ç¼–ç»‡è®°å¿†
                            </button>
                        </div>
                    </form>
                     <p id="form-error-msg" class="text-red-500 text-sm text-center my-2"></p>
                </div>
            </section>

            <div id="results-wrapper" class="hidden">
                <div id="loading-indicator" class="hidden text-center my-8">
                    <div class="inline-flex items-center bg-white p-4 rounded-lg shadow-md">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-indigo-600 font-semibold text-lg">è®°å¿†ç¼–ç»‡ä¸­ï¼Œè¯·ç¨å€™...</span>
                    </div>
                </div>

                <section id="multimedia-album-section" class="mb-12 card p-6 hidden">
                    <button id="album-toggle-button" type="button" class="album-toggle-button">
                        <span>æˆ‘çš„å¤šåª’ä½“ç´ æ (ç‚¹å‡»å±•å¼€/æŠ˜å )</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div id="album-content-area"> 
                        <div id="album-item-grid">
                            {/* Items populated by populateMultimediaAlbum() */}
                        </div>
                        <p id="album-placeholder" class="text-gray-500 text-center py-4 hidden">æ­£åœ¨åŠ è½½å¤šåª’ä½“å†…å®¹...</p>
                    </div>
                </section>
                <section id="streamed-narrative-section" class="mb-12 hidden">
                    <h2 class="section-title">æ¢ç´¢è®°å¿†ï¼Œé‡ç°å›å¿†</h2>
                    <div class="mb-6 flex items-center justify-center space-x-2">
                        <input type="text" id="interactive-prompt-input" class="interactive-prompt-input w-full md:w-3/5 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="å…³äºè¿™æ®µå›å¿†ï¼Œæ‚¨æƒ³äº†è§£æˆ–è¡¥å……ä»€ä¹ˆï¼Ÿ">
                        <button id="submit-interactive-prompt" type="button" class="btn-secondary px-6 py-3">æé—®</button>
                    </div>
                    <div class="card p-0">
                        <div id="streamed-narrative-container" class="streamed-narrative-container">
                            <p class="text-gray-500 text-center">æ­£åœ¨è¿æ¥AIï¼Œå‡†å¤‡ç¼–ç»‡å›å¿†...</p>
                        </div>
                    </div>
                </section>

                <section id="woven-memories-section" class="mb-12 hidden">
                    <h2 class="section-title">æˆ‘çš„è®°å¿†ç”»å· (æ‘˜è¦)</h2>
                    <div class="card p-6 md:p-8">
                        <h3 id="woven-title" class="text-2xl md:text-3xl font-semibold text-indigo-700 mb-4"></h3>
                        <div class="flex flex-wrap md:flex-nowrap gap-6">
                            <div class="w-full md:w-1/3">
                                <img id="woven-image" src="https://placehold.co/600x400/667eea/ffffff?text=æ—…è¡Œå½±åƒ" alt="æ—…è¡Œå½±åƒ" class="rounded-lg shadow-md mb-4 w-full h-auto object-cover aspect-video">
                                <div class="space-y-2 text-sm">
                                    <p><strong>ğŸ“ åœ°ç‚¹:</strong> <span id="woven-location"></span></p>
                                    <p><strong>ğŸ“… æ—…è¡Œæ—¶æ®µ:</strong> <span id="woven-date-range"></span></p>
                                    <p><strong>ğŸ¶ èƒŒæ™¯éŸ³ä¹:</strong> <span id="woven-music"></span></p>
                                </div>
                                <div class="mt-4">
                                    <h4 class="font-semibold text-gray-700 mb-2">è®°å¿†æ ‡ç­¾:</h4>
                                    <div id="woven-tags" class="flex flex-wrap"></div>
                                </div>
                            </div>
                            <div class="w-full md:w-2/3">
                                <h4 class="text-xl font-semibold text-gray-800 mb-3">AI ä¸ºæ‚¨ç¼–ç»‡çš„æ•…äº‹ (å¿«é€Ÿæ¦‚è§ˆ):</h4>
                                <div id="woven-story-container">
                                    <div id="woven-story-summary" class="prose prose-indigo max-w-none text-gray-700 leading-relaxed text-justify bg-gray-50 p-4 rounded-md h-60 overflow-y-auto">
                                    </div>
                                    <div class="mt-4 text-right">
                                        <button type="button" id="enhance-story-button" class="btn-secondary">
                                            âœ¨ AI æ·±å…¥æ¢è®¨æ­¤è®°å¿†
                                        </button>
                                        <div id="enhance-story-loading" class="hidden inline-flex items-center ml-2">
                                            <svg class="spinner h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span class="loading-text">æ·±å…¥æ¢è®¨ä¸­...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="exploration-section" class="mb-12 hidden">
                    <h2 class="section-title">AI æ™ºèƒ½æ´å¯Ÿä¸å†å²å›é¡¾</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold text-gray-800">âœ¨ AI æ™ºèƒ½æ´å¯Ÿ</h3>
                                <div id="insights-loading" class="hidden inline-flex items-center">
                                    <svg class="spinner h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="loading-text">ç”Ÿæˆä¸­...</span>
                                </div>
                            </div>
                            <ul id="ai-insights-list" class="text-gray-700 space-y-2 mb-4">
                                <li><strong class="text-indigo-600">ä¸»è¦ä¸»é¢˜:</strong> <span data-insight="themes">å¾…åˆ†æ...</span></li>
                                <li><strong class="text-green-600">æƒ…æ„Ÿå€¾å‘:</strong> <span data-insight="emotions">å¾…åˆ†æ...</span></li>
                                <li><strong class="text-blue-600">æœªæ¥å»ºè®®:</strong> <span data-insight="recommendation">å¾…åˆ†æ...</span></li>
                            </ul>
                             <p class="text-xs text-gray-500 italic">è¿™äº›æ´å¯Ÿç”± AI åŠ¨æ€ç”Ÿæˆã€‚</p>
                        </div>
                         <div class="card p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">å†å²è®°å¿†å›é¡¾ (æ¦‚å¿µ)</h3>
                            <div id="history-preview-list" class="space-y-3 max-h-60 overflow-y-auto">
                                <p class="text-gray-500">æš‚æ— å†å²è®°å¿†æˆ–åŠ è½½ä¸­...</p>
                            </div>
                            <button class="mt-4 btn-primary w-full">æŸ¥çœ‹æ‰€æœ‰å†å² (æ¦‚å¿µ)</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="floating-video-player" class="hidden fixed bottom-5 right-5 w-80 bg-white rounded-lg shadow-2xl z-[1000] p-3 flex flex-col opacity-0">
        <div class="flex justify-between items-center mb-2">
            <span id="video-caption" class="text-sm font-medium text-gray-700 truncate w-full pr-2">è§†é¢‘æ¼”ç¤º</span>
            <button id="close-video-player" type="button" class="text-xl text-gray-400 hover:text-gray-700 leading-none p-1 focus:outline-none">&times;</button>
        </div>
        <div class="bg-black rounded overflow-hidden h-44">
            <video id="video-element" class="w-full h-full object-cover" controls>
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
            </video>
        </div>
    </div>


    <footer class="bg-gray-800 text-white py-8 text-center">
        <p>&copy; 2025 è®°å¿†ç¼–ç»‡è€… (Weaver). ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        <p class="text-sm text-gray-400 mt-1">ç”¨å¿ƒç¼–ç»‡ï¼Œè®©è®°å¿†æ°¸æ’ã€‚</p>
    </footer>

    <script>
        // DOM Elements (existing)
        const weaveButton = document.getElementById('weave-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const formErrorMsg = document.getElementById('form-error-msg');
        const tripNameInput = document.getElementById('trip-name');
        const tripStartDateInput = document.getElementById('trip-start-date');
        const tripEndDateInput = document.getElementById('trip-end-date');
        const memoryLocationInput = document.getElementById('memory-location');
        const memoryTextInput = document.getElementById('memory-text');
        const memoryNotesFileInput = document.getElementById('memory-notes-file');
        const memoryPhotosInput = document.getElementById('memory-photos');
        const memoryMusicInput = document.getElementById('memory-music');
        const tabAddMemory = document.getElementById('tab-add-memory');
        const tabWeaveResults = document.getElementById('tab-weave-results');
        const uploadSection = document.getElementById('upload-section');
        const resultsWrapper = document.getElementById('results-wrapper');
        const streamedNarrativeSection = document.getElementById('streamed-narrative-section');
        const streamedNarrativeContainer = document.getElementById('streamed-narrative-container');
        const interactivePromptInput = document.getElementById('interactive-prompt-input');
        const submitInteractivePromptButton = document.getElementById('submit-interactive-prompt');
        const wovenMemoriesSection = document.getElementById('woven-memories-section');
        const wovenTitle = document.getElementById('woven-title');
        const wovenImage = document.getElementById('woven-image');
        const wovenLocationDisplay = document.getElementById('woven-location');
        const wovenDateRangeDisplay = document.getElementById('woven-date-range');
        const wovenMusicDisplay = document.getElementById('woven-music');
        const wovenStorySummaryDisplay = document.getElementById('woven-story-summary');
        const wovenTagsContainer = document.getElementById('woven-tags');
        const explorationSection = document.getElementById('exploration-section');
        const aiInsightsList = document.getElementById('ai-insights-list');
        const historyPreviewList = document.getElementById('history-preview-list');
        const enhanceStoryButton = document.getElementById('enhance-story-button');
        const enhanceStoryLoading = document.getElementById('enhance-story-loading');
        const insightsLoading = document.getElementById('insights-loading');

        // === START: Multimedia Album DOM Elements ===
        const multimediaAlbumSection = document.getElementById('multimedia-album-section');
        const albumToggleButton = document.getElementById('album-toggle-button');
        const albumContentArea = document.getElementById('album-content-area');
        const albumItemGrid = document.getElementById('album-item-grid');
        const albumPlaceholder = document.getElementById('album-placeholder');
        // === END: Multimedia Album DOM Elements ===

        // Floating Video Player DOM Elements
        const floatingVideoPlayer = document.getElementById('floating-video-player');
        const videoElement = document.getElementById('video-element');
        const videoCaption = document.getElementById('video-caption');
        const closeVideoPlayerButton = document.getElementById('close-video-player');

        let currentTripDetailsForAI = {};
        let currentWovenStoryForAI_Summary = "";
        let hasWovenDynamicContent = false;
        let currentStreamedNarrativeFullText = ""; // Stores the full narrative for context if needed

        // API Keys and Model Names (Gemini parts are still used for other functionalities)
        const GEMINI_API_KEY = "sk-Ce5ZSSasw3wtsEWtgUeaOy72yrrtab48YBSImx4fQ03nW5CA"; // User's original key
        const GEMINI_TEXT_MODEL = "gemini-1.5-flash";
        const IMAGEN_MODEL = "imagen-3.0-generate-002";

        // Keywords for dynamic content generation
        const HIGHLIGHT_KEYWORDS = ["æ™¯è‰²", "ç»å†", "é£å‘³", "æ„Ÿæ‚Ÿ", "å»ºç­‘", "æ²³æµ", "å±±è„‰", "å¸‚é›†", "å¤œæ™š", "æ˜Ÿç©º", "é˜³å…‰", "ç€‘å¸ƒ", "æ£®æ—", "æµ·æ»©", "æ—¥å‡º", "æ—¥è½", "å¥‡é‡", "ç¾å‘³", "æ„ŸåŠ¨", "å®é™", "ç¹å", "æ¢ç´¢å‘ç°"];
        const VIDEO_TRIGGER_KEYWORDS = ["è§†é¢‘è®°å½•æ˜¾ç¤º", "ç°åœºæ¼”ç¤º", "åŠ¨æ€è¿‡ç¨‹", "è§‚çœ‹è¿™æ®µå½±åƒ", "ç”ŸåŠ¨çš„ç¬é—´"];

        // === START: Mock data for album ===
        const mockAlbumDetails = {
            notes: "è¿™æ˜¯ä¸€æ®µå…³äºåŒ—æµ·é“å†¬æ—¥é›ªæ™¯çš„ç¬”è®°ï¼Œè®°å½•äº†åœ¨å°æ¨½è¿æ²³è¾¹æ¼«æ­¥ï¼Œå“å°æ–°é²œæµ·äº§ï¼Œä»¥åŠåœ¨æœ­å¹Œé›ªç¥­ä¸Šæ„Ÿå—åˆ°çš„æ¬¢ä¹æ°”æ°›ã€‚",
            photosCount: 3, // Simulate 3 photos
            music: "å†¬å­£æ‹æ­Œ - ä¸»é¢˜æ›²"
        };
        // === END: Mock data for album ===

        // --- Tab Navigation ---
        function setActiveTab(activeTabId) {
            if (activeTabId === 'tab-add-memory') {
                tabAddMemory.classList.add('active');
                tabWeaveResults.classList.remove('active');
                uploadSection.classList.remove('hidden');
                resultsWrapper.classList.add('hidden');
                hideFloatingVideoPlayer();
                if (multimediaAlbumSection) multimediaAlbumSection.classList.add('hidden'); // Hide album when on add tab
            } else if (activeTabId === 'tab-weave-results') {
                tabWeaveResults.classList.add('active');
                tabAddMemory.classList.remove('active');
                uploadSection.classList.add('hidden');
                resultsWrapper.classList.remove('hidden');

                // === START: Album logic in tab switch ===
                if (multimediaAlbumSection) { // Ensure element exists
                    multimediaAlbumSection.classList.remove('hidden');
                    // Populate based on whether actual content has been woven
                    populateMultimediaAlbum(hasWovenDynamicContent ? currentTripDetailsForAI : mockAlbumDetails);
                }
                // === END: Album logic in tab switch ===

                streamedNarrativeSection.classList.remove('hidden');

                if (!hasWovenDynamicContent) {
                    initiateNarrativeStreamWithGemini(null, true);
                    wovenMemoriesSection.classList.add('hidden');
                    explorationSection.classList.add('hidden');
                } else {
                    initiateNarrativeStreamWithGemini(currentTripDetailsForAI, false);
                    wovenMemoriesSection.classList.remove('hidden');
                    explorationSection.classList.remove('hidden');
                }
            }
        }

        tabAddMemory.addEventListener('click', () => setActiveTab('tab-add-memory'));
        tabWeaveResults.addEventListener('click', () => setActiveTab('tab-weave-results'));

        // --- Interactive Prompt Handling (custom API) ---
        // This function is THE USER'S VERSION that was previously confirmed as working. NO CHANGES HERE.
        async function handleInteractivePromptWithCustomAPI(userPrompt) {
            const thinkingMsg = document.createElement('p');
            thinkingMsg.className = 'text-gray-500 text-center my-2 italic';
            thinkingMsg.textContent = 'æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚ï¼Œè¿™å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...';
            streamedNarrativeContainer.appendChild(thinkingMsg);
            streamedNarrativeContainer.scrollTop = streamedNarrativeContainer.scrollHeight;

            const customApiUrl = 'http://localhost:5000/api/chat';

            console.log(`[${new Date().toLocaleTimeString()}] å¼€å§‹è°ƒç”¨è‡ªå®šä¹‰æ¥å£: ${customApiUrl}`);
            console.log(`[${new Date().toLocaleTimeString()}] è¯·æ±‚ä½“ (Payload):`, { message: userPrompt });

            try {
                const payload = { message: userPrompt };
                const response = await fetch(customApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(`[${new Date().toLocaleTimeString()}] æ”¶åˆ°APIå“åº”ã€‚çŠ¶æ€ç : ${response.status}, Ok: ${response.ok}`);

                if (streamedNarrativeContainer.contains(thinkingMsg)) {
                    streamedNarrativeContainer.removeChild(thinkingMsg);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[${new Date().toLocaleTimeString()}] APIè¿”å›é”™è¯¯çŠ¶æ€ï¼Œå“åº”ä½“:`, errorText);
                    throw new Error(`è‡ªå®šä¹‰æ¥å£è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                console.log(`[${new Date().toLocaleTimeString()}] APIå“åº”æˆåŠŸï¼Œæ­£åœ¨è§£æJSON...`);
                const responseData = await response.json();
                console.log(`[${new Date().toLocaleTimeString()}] JSONè§£æç»“æœ:`, responseData);

                if (responseData && responseData.success && typeof responseData.message !== 'undefined') {
                    const actualMessage = responseData.message;
                    currentStreamedNarrativeFullText += `\n\nç”¨æˆ·æé—® (è‡ªå®šä¹‰æ¥å£)ï¼š${userPrompt}\n\n${actualMessage}`;
                    await streamTextToContainer(actualMessage, "æ¥å£å›åº”ï¼š");
                    console.log(`[${new Date().toLocaleTimeString()}] æˆåŠŸå¤„ç†å¹¶æ˜¾ç¤ºAPIæ¶ˆæ¯ã€‚`);
                } else {
                    console.error(`[${new Date().toLocaleTimeString()}] APIå“åº”æˆåŠŸä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–æ“ä½œæœªæˆåŠŸ:`, responseData);
                    throw new Error(`APIå“åº”æˆåŠŸä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®æˆ–æ“ä½œæœªæˆåŠŸ: ${JSON.stringify(responseData)}`);
                }

            } catch (error) {
                console.error(`[${new Date().toLocaleTimeString()}] è°ƒç”¨è‡ªå®šä¹‰æ¥å£è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:`, error);
                if (streamedNarrativeContainer.contains(thinkingMsg)) {
                    streamedNarrativeContainer.removeChild(thinkingMsg);
                }
                const errorMessage = error && error.message ? error.message : "æœªçŸ¥é”™è¯¯";
                appendSystemMessageToStream(`å¤„ç†æ‚¨çš„æé—®æ—¶å‡ºé”™ (è‡ªå®šä¹‰æ¥å£)ï¼š${errorMessage}`, "text-red-500");
            }
        }
        submitInteractivePromptButton.addEventListener('click', () => {
            const promptText = interactivePromptInput.value.trim();
            if (promptText) {
                console.log("Interactive prompt submitted to custom API:", promptText);
                appendUserMessageToStream(promptText);
                handleInteractivePromptWithCustomAPI(promptText); // Uses the function above
                interactivePromptInput.value = '';
            }
            interactivePromptInput.classList.remove('md:w-3/5');
            interactivePromptInput.classList.add('md:w-2/5');
            setTimeout(() => {
                 interactivePromptInput.classList.remove('md:w-2/5');
                 interactivePromptInput.classList.add('md:w-3/5');
            }, 2000);
        });


        // --- Floating Video Player ---
        closeVideoPlayerButton.addEventListener('click', hideFloatingVideoPlayer);

        function showFloatingVideoPlayer(paragraphText) {
            console.log("Showing floating video player for paragraph:", paragraphText.substring(0, 50) + "...");
            videoCaption.textContent = "è§†é¢‘: " + (paragraphText.substring(0, 30) + "..." || "ç›¸å…³å½±åƒ");
            videoElement.src = "https://www.w3schools.com/html/mov_bbb.mp4"; // Placeholder video
            floatingVideoPlayer.classList.remove('hidden');
            setTimeout(() => {
                floatingVideoPlayer.classList.add('visible');
                floatingVideoPlayer.classList.remove('opacity-0');
            }, 50);
            videoElement.play().catch(e => console.warn("Video play failed, possibly due to browser policy:", e));
        }

        function hideFloatingVideoPlayer() {
            floatingVideoPlayer.classList.remove('visible');
            floatingVideoPlayer.classList.add('opacity-0');
            setTimeout(() => {
                floatingVideoPlayer.classList.add('hidden');
            }, 300);
            videoElement.pause();
            videoElement.currentTime = 0;
        }

        // --- Stream Utility Functions ---
        function appendUserMessageToStream(message) {
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'my-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-700 text-right';
            userMsgDiv.innerHTML = `<p class="font-semibold">æ‚¨ï¼š</p><p>${message}</p>`;
            streamedNarrativeContainer.appendChild(userMsgDiv);
            streamedNarrativeContainer.scrollTop = streamedNarrativeContainer.scrollHeight;
        }

        function appendSystemMessageToStream(message, cssClass = "text-gray-500") {
            const sysMsgDiv = document.createElement('div');
            sysMsgDiv.className = `my-4 p-3 bg-gray-100 border border-gray-200 rounded-lg ${cssClass}`;
            sysMsgDiv.innerHTML = `<p>${message}</p>`;
            streamedNarrativeContainer.appendChild(sysMsgDiv);
            streamedNarrativeContainer.scrollTop = streamedNarrativeContainer.scrollHeight;
        }

        // --- Main Weaving Logic (Uses Gemini for initial story and image generation) ---
        // UNCHANGED from user's provided code
        weaveButton.addEventListener('click', async () => {
            formErrorMsg.textContent = "";
            const tripName = tripNameInput.value.trim();
            const tripStartDate = tripStartDateInput.value;
            const tripEndDate = tripEndDateInput.value;
            const memoryLocation = memoryLocationInput.value.trim();
            let memoryTextContent = memoryTextInput.value.trim();
            const notesFile = memoryNotesFileInput.files[0];
            const photoFiles = memoryPhotosInput.files;
            const memoryMusic = memoryMusicInput.value.trim();

            if (!tripName || !tripStartDate || !memoryLocation) {
                formErrorMsg.textContent = "æ—…ç¨‹åç§°ã€å¼€å§‹æ—¥æœŸå’Œåœ°ç‚¹æ ‡è®°ä¸èƒ½ä¸ºç©ºï¼"; return;
            }
            if (tripEndDate && tripEndDate < tripStartDate) {
                formErrorMsg.textContent = "ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼"; return;
            }
            if (notesFile) {
                try { memoryTextContent = await notesFile.text(); }
                catch (e) { formErrorMsg.textContent = "è¯»å–ç¬”è®°æ–‡ä»¶å¤±è´¥ã€‚"; return; }
            }
             if (!memoryTextContent && (!photoFiles || photoFiles.length === 0) ) { // Check if photoFiles itself is null or length 0
                 formErrorMsg.textContent = "è¯·æä¾›æ–‡å­—æ„Ÿæ‚Ÿæˆ–ä¸Šä¼ ç…§ç‰‡ã€‚"; return;
            }

            currentTripDetailsForAI = {
                name: tripName, startDate, endDate: tripEndDate, location: memoryLocation,
                notes: memoryTextContent, music: memoryMusic, photosCount: photoFiles ? photoFiles.length : 0
            };

            hasWovenDynamicContent = true;
            setActiveTab('tab-weave-results'); // This will now also call populateMultimediaAlbum

            loadingIndicator.classList.remove('hidden');
            wovenMemoriesSection.classList.add('hidden');
            explorationSection.classList.add('hidden');
            streamedNarrativeSection.classList.remove('hidden');

            await initiateNarrativeStreamWithGemini(currentTripDetailsForAI, false);

            setTimeout(async () => {
                loadingIndicator.classList.add('hidden');
                wovenTitle.textContent = `${tripName} - è®°å¿†æ‘˜è¦`;
                if (photoFiles && photoFiles.length > 0) {
                     try {
                        // Create a URL for the first uploaded file to display it.
                        // This is client-side only and doesn't involve actual upload to a server yet.
                        wovenImage.src = URL.createObjectURL(photoFiles[0]);
                        // Optional: Revoke the object URL when it's no longer needed to free up resources
                        // wovenImage.onload = () => { URL.revokeObjectURL(wovenImage.src); }
                    } catch (e) {
                        console.warn("Could not create object URL for photo, using placeholder.", e);
                        wovenImage.src = `https://placehold.co/600x400/764ba2/ffffff?text=${encodeURIComponent(tripName.substring(0,10))}`;
                    }
                } else {
                    wovenImage.src = `https://placehold.co/600x400/667eea/ffffff?text=${encodeURIComponent(tripName.substring(0,10)) || 'æ—…è¡Œå½±åƒ'}`;
                }
                wovenImage.alt = tripName;
                wovenLocationDisplay.textContent = memoryLocation;
                let dateText = tripStartDate;
                if (tripEndDate) dateText += ` è‡³ ${tripEndDate}`;
                wovenDateRangeDisplay.textContent = dateText;
                wovenMusicDisplay.textContent = memoryMusic || "æœªè®°å½•";

                currentWovenStoryForAI_Summary = `<p>${(memoryTextContent || "ä¸€æ¬¡éš¾å¿˜çš„æ—…è¡Œ").substring(0, 150).replace(/\n/g, '<br>')}...</p><p class="text-sm text-gray-500 mt-2">(è¯¦ç»†å›å¿†è¯·æŸ¥çœ‹ä¸Šæ–¹â€œæ¢ç´¢è®°å¿†ï¼Œé‡ç°å›å¿†â€åŒºåŸŸ)</p>`;
                wovenStorySummaryDisplay.innerHTML = currentWovenStoryForAI_Summary;

                wovenTagsContainer.innerHTML = '';
                const tagsSet = new Set(['æ—…è¡Œ', tripName.substring(0,5).trim(), ...memoryLocation.split(',').map(s => s.trim().substring(0,10))]);
                if (memoryMusic) tagsSet.add(memoryMusic.split('-')[0].trim().substring(0,10));
                tagsSet.forEach(tagText => {
                    if(tagText) {
                        const tag = document.createElement('span');
                        tag.className = 'tag';
                        tag.textContent = tagText;
                        wovenTagsContainer.appendChild(tag);
                    }
                });

                wovenMemoriesSection.classList.remove('hidden');
                explorationSection.classList.remove('hidden');
                await generateInsightsWithAI(currentTripDetailsForAI);
                updateHistoryPreview({
                    id: Date.now(), title: tripName, date: tripStartDate,
                    snippet: (memoryTextContent || "ä¸€æ¬¡éš¾å¿˜çš„æ—…è¡Œ").substring(0, 50) + "..."
                });
            }, 500);
        });

        // --- Text Streaming and Dynamic Content (Images/Video Placeholders) ---
        // UNCHANGED from user's provided code
        async function streamTextToContainer(text, prefix = "") {
            const paragraphs = text.split('\n\n').filter(p => p.trim() !== '');
            for (let i = 0; i < paragraphs.length; i++) {
                const paragraphText = paragraphs[i];
                const pElement = document.createElement('div');
                pElement.className = 'narrative-item';

                const textSpan = document.createElement('span');
                textSpan.className = 'narrative-text-content';
                if (i === 0 && prefix) {
                    const prefixStrong = document.createElement('strong');
                    prefixStrong.textContent = prefix;
                    textSpan.appendChild(prefixStrong);
                    textSpan.appendChild(document.createElement('br'));
                }
                pElement.appendChild(textSpan);
                streamedNarrativeContainer.appendChild(pElement);

                const words = paragraphText.split(' ');
                for (const word of words) {
                    textSpan.innerHTML += word + ' ';
                    await new Promise(resolve => setTimeout(resolve, 30));
                    streamedNarrativeContainer.scrollTop = streamedNarrativeContainer.scrollHeight;
                }
                textSpan.innerHTML = textSpan.innerHTML.trim();

                const containsHighlightKeyword = HIGHLIGHT_KEYWORDS.some(keyword => paragraphText.includes(keyword));
                const containsVideoKeyword = VIDEO_TRIGGER_KEYWORDS.some(keyword => paragraphText.includes(keyword));

                if (containsHighlightKeyword && !containsVideoKeyword) {
                    console.log("Keyword found, triggering image generation for:", paragraphText.substring(0,50) + "...");
                    textSpan.classList.add('highlighted-text-segment');
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'generated-image-container';
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner image-generation-spinner';
                    imageContainer.appendChild(spinner);
                    pElement.appendChild(imageContainer);

                    setTimeout(async () => {
                        try {
                            const imageUrl = await generateImageWithImagenAPI(paragraphText.substring(0, 200)); // Max 200 chars for prompt
                            console.log("Image generated successfully for:", paragraphText.substring(0,50) + "...");
                            imageContainer.innerHTML = '';
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = `AI ç”Ÿæˆçš„å…³äºâ€œ${paragraphText.substring(0, 20)}...â€çš„å›¾ç‰‡`;
                            imageContainer.appendChild(img);
                        } catch (imgError) {
                            console.error("Image generation error:", imgError);
                            imageContainer.innerHTML = '<p class="text-xs text-red-500">å›¾ç‰‡ç”Ÿæˆå¤±è´¥</p>';
                        }
                    }, 1000);
                } else if (containsVideoKeyword) {
                    console.log("Video keyword found, showing floating video for:", paragraphText.substring(0,50) + "...");
                    showFloatingVideoPlayer(paragraphText);
                }

                 if (i < paragraphs.length - 1) {
                    textSpan.innerHTML += '<br><br>';
                }
            }
        }

        // --- Gemini API for Initial Narrative Stream ---
        // UNCHANGED from user's provided code (including Authorization header)
        async function initiateNarrativeStreamWithGemini(tripDetails, isPlaceholder = false) {
            streamedNarrativeContainer.innerHTML = `<p class="text-gray-500 text-center">${isPlaceholder ? 'æ­£åœ¨åŠ è½½ç¤ºä¾‹å›å¿†...' : 'AI æ­£åœ¨ä¸ºæ‚¨ç¼–ç»‡å›å¿†ï¼Œè¯·ç¨å€™...'}</p>`;
            currentStreamedNarrativeFullText = "";
            hideFloatingVideoPlayer();
            let prompt;

            if (isPlaceholder) {
                prompt = "è¯·ä¸ºæˆ‘ç¼–ç»‡ä¸€æ®µå…³äºä¸€æ¬¡æ„å¤–å‘ç°ä¸€ä¸ªéšè—ç€‘å¸ƒçš„æ—…è¡Œçš„ç¤ºä¾‹å›å¿†ã€‚åŒ…å«ä¸€äº›æ™¯è‰²æå†™å’Œå½“æ—¶çš„å¿ƒæƒ…ã€‚ç”¨ä¸­æ–‡å†™ï¼Œåˆ†æˆ3-4ä¸ªæ®µè½ã€‚ç¡®ä¿åŒ…å«ä¸€äº›å…³é”®è¯ï¼Œä¾‹å¦‚â€œç¾ä¸½çš„æ™¯è‰²â€æˆ–â€œæ¸…æ¾ˆçš„æ²³æµâ€æˆ–â€œç€‘å¸ƒâ€ã€‚åœ¨å…¶ä¸­ä¸€æ®µå°è¯•åŒ…å«â€œè§†é¢‘è®°å½•æ˜¾ç¤ºäº†æ°´æµçš„åŠ¨æ€è¿‡ç¨‹â€ã€‚";
            } else {
                prompt = `è¯·ä¸ºæˆ‘ç¼–ç»‡ä¸€æ®µå…³äºæ—…ç¨‹â€œ${tripDetails.name}â€çš„è¯¦ç»†å›å¿†ã€‚\nåœ°ç‚¹ï¼š${tripDetails.location}\næ—¥æœŸï¼š${tripDetails.startDate}${tripDetails.endDate ? ' è‡³ ' + tripDetails.endDate : ''}\næˆ‘çš„ç¬”è®°ï¼š\n${tripDetails.notes}\nå½“æ—¶å¬çš„éŸ³ä¹ï¼š${tripDetails.music || 'æœªè®°å½•'}\n\nè¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯æˆ‘çš„ç¬”è®°ï¼Œç”¨ç”ŸåŠ¨çš„è¯­è¨€ã€ä¸°å¯Œçš„ç»†èŠ‚å’Œæƒ…æ„Ÿæ¥æç»˜è¿™æ®µæ—…ç¨‹ã€‚è¯·åˆ†æˆå¤šä¸ªæ®µè½ï¼Œç”¨ä¸­æ–‡å†™ã€‚è¯·å°è¯•åœ¨æè¿°ä¸­è‡ªç„¶åœ°ä½¿ç”¨ä¸€äº›è¯è¯­ï¼Œå¦‚ï¼šâ€œæ™¯è‰²â€ã€â€œç»å†â€ã€â€œç€‘å¸ƒâ€ã€â€œæ£®æ—â€ã€â€œæµ·æ»©â€ã€â€œæ—¥å‡ºâ€ã€â€œæ—¥è½â€ã€â€œæ„Ÿæ‚Ÿâ€ã€â€œå»ºç­‘â€ã€â€œæ²³æµâ€ã€â€œå±±è„‰â€ã€â€œå¸‚é›†â€ã€â€œå¤œæ™šâ€ã€â€œæ˜Ÿç©ºâ€ã€â€œé˜³å…‰â€ã€‚å¦‚æœåˆé€‚ï¼Œå¯ä»¥åŠ å…¥ä¸€å¥å¦‚â€œè§†é¢‘è®°å½•æ˜¾ç¤ºäº†å½“æ—¶çš„åŠ¨æ€è¿‡ç¨‹â€æ¥è§¦å‘è§†é¢‘ã€‚`;
            }

            try {
                const chatHistory = [{ role: "user", content: prompt }];
                const payload = { messages: chatHistory, model: GEMINI_TEXT_MODEL };
                const apiUrl = `https://api.openai-proxy.org/v1/chat/completions`; // User's proxy
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', "Authorization": GEMINI_API_KEY}, body: JSON.stringify(payload) });


                if (!response.ok) throw new Error(`Gemini API è¯·æ±‚å¤±è´¥: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const fullText = result.candidates[0].content.parts[0].text;
                    currentStreamedNarrativeFullText = fullText;
                    streamedNarrativeContainer.innerHTML = '';
                    await streamTextToContainer(fullText);
                } else {
                    streamedNarrativeContainer.innerHTML = '<p class="text-red-500 text-center">AIæ­£åœ¨ç”Ÿæˆå›å¿†å†…å®¹ã€‚</p>';
                }
            } catch (error) {
                console.error("æµå¼å›å¿†ç”Ÿæˆå¤±è´¥ (Gemini):", error);
                streamedNarrativeContainer.innerHTML = `<p class="text-red-500 text-center">åŠ è½½å›å¿†æ—¶å‡ºé”™ï¼š${error.message}</p>`;
            }
        }

        // --- Text2Image API for Image Generation (called from streamTextToContainer) ---
        async function generateImageWithImagenAPI(promptText) {
            console.log("Requesting image from localhost text2image API with prompt:", promptText);
            
            const customApiUrl = 'http://localhost:5000/api/chat/text2image';
            const payload = { text: promptText };

            console.log(`[${new Date().toLocaleTimeString()}] å¼€å§‹è°ƒç”¨æ–‡æœ¬ç”Ÿæˆå›¾ç‰‡æ¥å£: ${customApiUrl}`);
            console.log(`[${new Date().toLocaleTimeString()}] è¯·æ±‚ä½“ (Payload):`, payload);

            try {
                const response = await fetch(customApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log(`[${new Date().toLocaleTimeString()}] æ”¶åˆ°å›¾ç‰‡ç”ŸæˆAPIå“åº”ã€‚çŠ¶æ€ç : ${response.status}, Ok: ${response.ok}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[${new Date().toLocaleTimeString()}] å›¾ç‰‡ç”ŸæˆAPIè¿”å›é”™è¯¯çŠ¶æ€ï¼Œå“åº”ä½“:`, errorText);
                    throw new Error(`æ–‡æœ¬ç”Ÿæˆå›¾ç‰‡æ¥å£è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                console.log(`[${new Date().toLocaleTimeString()}] å›¾ç‰‡ç”ŸæˆAPIå“åº”æˆåŠŸï¼Œæ­£åœ¨è§£æJSON...`);
                const responseData = await response.json();
                console.log(`[${new Date().toLocaleTimeString()}] å›¾ç‰‡ç”ŸæˆJSONè§£æç»“æœ:`, responseData);

                if (responseData && responseData.success && responseData.image_data) {
                    // Get the first image URL from the image_data object
                    const imageUrls = Object.values(responseData.image_data);
                    if (imageUrls.length > 0) {
                        console.log("Text2Image API success, returning first image URL:", imageUrls[0]);
                        return imageUrls[0];
                    } else {
                        throw new Error("å›¾ç‰‡ç”ŸæˆæˆåŠŸä½†æœªè¿”å›å›¾ç‰‡URL");
                    }
                } else {
                    console.error(`[${new Date().toLocaleTimeString()}] å›¾ç‰‡ç”ŸæˆAPIå“åº”æˆåŠŸä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®:`, responseData);
                    throw new Error(`å›¾ç‰‡ç”ŸæˆAPIå“åº”æˆåŠŸä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®: ${JSON.stringify(responseData)}`);
                }

            } catch (error) {
                console.error(`[${new Date().toLocaleTimeString()}] è°ƒç”¨æ–‡æœ¬ç”Ÿæˆå›¾ç‰‡æ¥å£è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:`, error);
                const errorMessage = error && error.message ? error.message : "æœªçŸ¥é”™è¯¯";
                console.error("Image generation error:", errorMessage);
                // Return placeholder on error
                throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${errorMessage}`);
            }
        }

        // --- Gemini API for Enhancing Story Summary ---
        // UNCHANGED from user's provided code (including Authorization header)
        enhanceStoryButton.addEventListener('click', async () => {
            enhanceStoryButton.disabled = true;
            enhanceStoryLoading.classList.remove('hidden');
            const originalSummary = wovenStorySummaryDisplay.innerHTML;
            wovenStorySummaryDisplay.innerHTML += `<p class="text-center text-indigo-600 my-2">AI æ­£åœ¨æ·±å…¥æ€è€ƒ...</p>`;

            const prompt = `è¿™æ˜¯ä¸€æ®µæ—…è¡Œè®°å¿†çš„æ‘˜è¦ï¼š\næ—…ç¨‹åç§°ï¼š${currentTripDetailsForAI.name}ï¼Œåœ°ç‚¹ï¼š${currentTripDetailsForAI.location}\nç”¨æˆ·ç¬”è®°ï¼š${currentTripDetailsForAI.notes}\næ‘˜è¦å†…å®¹ï¼š${currentWovenStoryForAI_Summary.replace(/<[^>]*>/g, '')} \nè¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œå¯¹è¿™æ®µè®°å¿†è¿›è¡Œæ›´æ·±å…¥çš„æ¢è®¨å’Œç»†èŠ‚è¡¥å……ï¼Œè¿”å›ä¸€æ®µçº¦2-3ä¸ªæ®µè½çš„ä¸°å¯Œæè¿° (HTMLæ ¼å¼ï¼Œä½¿ç”¨ <p> æ ‡ç­¾)ã€‚`;

            try {
                const chatHistory = [{ role: "user", content: prompt }];
                const payload = { messages: chatHistory, model: GEMINI_TEXT_MODEL };
                const apiUrl = `https://api.openai-proxy.org/v1/chat/completions`; // User's proxy
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', "Authorization": GEMINI_API_KEY}, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Gemini API è¯·æ±‚å¤±è´¥: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const enhancedText = result.candidates[0].content.parts[0].text;
                    wovenStorySummaryDisplay.innerHTML = enhancedText;
                    currentWovenStoryForAI_Summary = enhancedText;
                } else {
                     wovenStorySummaryDisplay.innerHTML = originalSummary + `<p class="text-red-500 text-center">AI æ·±å…¥æ¢è®¨å¤±è´¥ã€‚</p>`;
                }
            } catch (error) {
                console.error("Enhance story error:", error);
                wovenStorySummaryDisplay.innerHTML = originalSummary + `<p class="text-red-500 text-center">é”™è¯¯: ${error.message}</p>`;
            } finally {
                enhanceStoryLoading.classList.add('hidden');
            }
        });

        // --- Gemini API for AI Insights ---
        // UNCHANGED from user's provided code (including Authorization header and responseSchema)
        async function generateInsightsWithAI(tripDetails) {
            insightsLoading.classList.remove('hidden');
            aiInsightsList.querySelector('[data-insight="themes"]').textContent = 'åˆ†æä¸­...';
            aiInsightsList.querySelector('[data-insight="emotions"]').textContent = 'åˆ†æä¸­...';
            aiInsightsList.querySelector('[data-insight="recommendation"]').textContent = 'åˆ†æä¸­...';

            const prompt = `è¿™æ˜¯ä¸€æ¬¡æ—…è¡Œçš„è¯¦ç»†ä¿¡æ¯ï¼š\næ—…ç¨‹åç§°ï¼š${tripDetails.name}ï¼Œåœ°ç‚¹ï¼š${tripDetails.location}ï¼Œæ—¶æ®µï¼š${tripDetails.startDate}è‡³${tripDetails.endDate || tripDetails.startDate}ã€‚\nç”¨æˆ·ç¬”è®°ï¼š${tripDetails.notes}ï¼ŒéŸ³ä¹ï¼š${tripDetails.music || 'æœªè®°å½•'}\nè¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œä¸ºç”¨æˆ·æä¾›æ—…è¡Œæ´å¯Ÿã€‚è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹é”®ï¼š'themes' (å­—ç¬¦ä¸²æ•°ç»„ï¼Œ2-3ä¸ªä¸»è¦ä¸»é¢˜), 'emotions' (å­—ç¬¦ä¸²æ•°ç»„ï¼Œ1-2ä¸ªä¸»è¦æƒ…æ„Ÿå€¾å‘), 'recommendation' (å­—ç¬¦ä¸²ï¼Œä¸€ä¸ªæœªæ¥æ¨è)ã€‚è¯·ç”¨ä¸­æ–‡æä¾›æ‰€æœ‰æ–‡æœ¬å†…å®¹ã€‚`;

            const generationConfig = { // This was in user's original code, keeping it.
                responseMimeType: "application/json",
                responseSchema: { type: "OBJECT", properties: {
                        "themes": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "emotions": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "recommendation": { "type": "STRING" }
                    }, required: ["themes", "emotions", "recommendation"]
                }
            };

            try {
                const chatHistory = [{ role: "user", content: prompt }];
                // Note: generationConfig is defined but not directly used in the fetch payload here
                // This matches the user's provided code. If it's meant to be used, the payload or API call might need adjustment
                // For now, keeping it as is to not modify the API call.
                const payload = { messages: chatHistory, model: GEMINI_TEXT_MODEL /*, generationConfig: generationConfig */ }; // User had generationConfig here in comment, keeping as is
                const apiUrl = `https://api.openai-proxy.org/v1/chat/completions`; // User's proxy
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', "Authorization": GEMINI_API_KEY}, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`Gemini API (Insights) è¯·æ±‚å¤±è´¥: ${response.status}`);
                const result = await response.json();

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const insightsJSONString = result.candidates[0].content.parts[0].text;
                    try {
                        const insights = JSON.parse(insightsJSONString.replace(/```json\n?|\n?```/g, '').trim()); // Clean potential markdown
                        aiInsightsList.querySelector('[data-insight="themes"]').textContent = insights.themes && insights.themes.length > 0 ? insights.themes.join(', ') : 'æœªèƒ½åˆ†æ';
                        aiInsightsList.querySelector('[data-insight="emotions"]').textContent = insights.emotions && insights.emotions.length > 0 ? insights.emotions.join(', ') : 'æœªèƒ½åˆ†æ';
                        aiInsightsList.querySelector('[data-insight="recommendation"]').textContent = insights.recommendation || 'æœªèƒ½æä¾›';
                    } catch (parseError) {
                        console.error("Error parsing insights JSON:", parseError, "Raw text:", insightsJSONString);
                        throw new Error("AI æ´å¯Ÿè¿”å›äº†æ— æ•ˆçš„JSONæ ¼å¼ã€‚");
                    }
                } else {
                    throw new Error("AI æ´å¯Ÿæœªèƒ½è·å–æœ‰æ•ˆå†…å®¹ã€‚");
                }
            } catch (error) {
                console.error("Generate insights error:", error);
                aiInsightsList.querySelector('[data-insight="themes"]').textContent = `é”™è¯¯`;
                aiInsightsList.querySelector('[data-insight="emotions"]').textContent = 'å¤±è´¥';
                aiInsightsList.querySelector('[data-insight="recommendation"]').textContent = 'å¤±è´¥';
            } finally {
                insightsLoading.classList.add('hidden');
            }
        }

        // --- Mock History Preview ---
        let mockHistoryStore = [];
        function updateHistoryPreview(newItem) {
            if (newItem) {
                mockHistoryStore.unshift(newItem);
                if (mockHistoryStore.length > 5) mockHistoryStore.pop();
            }
            historyPreviewList.innerHTML = '';
            if (mockHistoryStore.length === 0) {
                historyPreviewList.innerHTML = '<p class="text-gray-500">æš‚æ— å†å²è®°å¿†ã€‚</p>'; return;
            }
            mockHistoryStore.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded-md shadow-sm hover:bg-gray-100 transition-colors cursor-pointer';
                div.innerHTML = `<h5 class="font-semibold text-sm text-indigo-700">${item.title}</h5><p class="text-xs text-gray-500">${item.date}</p><p class="text-xs text-gray-600 mt-1">${item.snippet}</p>`;
                div.addEventListener('click', () => {
                    formErrorMsg.textContent = `æ¦‚å¿µï¼šå·²é€‰æ‹©å†å²è®°å¿† "${item.title}"ã€‚å®é™…åŠ è½½é€»è¾‘å¯åœ¨æ­¤å®ç°ã€‚`;
                    tripNameInput.value = item.title;
                });
                historyPreviewList.appendChild(div);
            });
        }

        // === START: Album API Functions ===
        async function fetchMemoryAlbumFromAPI(memoryId = null) {
            try {
                const albumApiUrl = 'http://localhost:5000/api/memories/album';
                const url = memoryId ? `${albumApiUrl}?memory_id=${encodeURIComponent(memoryId)}` : albumApiUrl;
                
                console.log(`[${new Date().toLocaleTimeString()}] å¼€å§‹è°ƒç”¨è®°å¿†ç›¸å†Œæ¥å£: ${url}`);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                console.log(`[${new Date().toLocaleTimeString()}] æ”¶åˆ°ç›¸å†ŒAPIå“åº”ã€‚çŠ¶æ€ç : ${response.status}, Ok: ${response.ok}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`[${new Date().toLocaleTimeString()}] ç›¸å†ŒAPIè¿”å›é”™è¯¯çŠ¶æ€ï¼Œå“åº”ä½“:`, errorText);
                    throw new Error(`è®°å¿†ç›¸å†Œæ¥å£è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const responseData = await response.json();
                console.log(`[${new Date().toLocaleTimeString()}] ç›¸å†ŒAPI JSONè§£æç»“æœ:`, responseData);

                if (responseData && responseData.success && responseData.album) {
                    return responseData.album;
                } else {
                    console.warn(`[${new Date().toLocaleTimeString()}] ç›¸å†ŒAPIå“åº”æˆåŠŸä½†æ•°æ®æ ¼å¼ä¸æ­£ç¡®:`, responseData);
                    return [];
                }

            } catch (error) {
                console.error(`[${new Date().toLocaleTimeString()}] è°ƒç”¨è®°å¿†ç›¸å†Œæ¥å£è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:`, error);
                return [];
            }
        }
        // === END: Album API Functions ===

        // === START: Multimedia Album Functionality ===
        async function populateMultimediaAlbum(tripDetails) {
            if (!albumItemGrid || !albumPlaceholder || !multimediaAlbumSection) {
                console.error("Album DOM elements not found!");
                return;
            }
            
            console.log("Populating multimedia album with tripDetails:", tripDetails);
            albumItemGrid.innerHTML = ''; // Clear previous items
            let itemCount = 0;

            // First, try to fetch content from API
            albumPlaceholder.classList.remove('hidden');
            albumPlaceholder.textContent = "æ­£åœ¨åŠ è½½å¤šåª’ä½“å†…å®¹...";
            
            console.log("Fetching album content from API...");
            const apiAlbumContent = await fetchMemoryAlbumFromAPI();
            console.log("API album content received:", apiAlbumContent);
            
            // Display API content first if available
            if (apiAlbumContent && apiAlbumContent.length > 0) {
                console.log(`Displaying ${apiAlbumContent.length} API album items`);
                apiAlbumContent.forEach((content, index) => {
                    itemCount++;
                    const apiDiv = document.createElement('div');
                    apiDiv.className = 'note-component !bg-green-50 !border-green-200 !text-green-700';
                    apiDiv.innerHTML = `<h5><i class="fas fa-database mr-2"></i>è®°å¿†ç‰‡æ®µ ${index + 1}</h5><p>${content.substring(0, 120).replace(/\n/g, '<br>')}${content.length > 120 ? '...' : ''}</p>`;
                    albumItemGrid.appendChild(apiDiv);
                });
            } else {
                console.log("No API album content available, using mock/tripDetails data");
            }

            // Then display existing tripDetails or mock data
            const detailsToUse = tripDetails && Object.keys(tripDetails).length > 0 ? tripDetails : mockAlbumDetails;
            console.log("Using details for album:", detailsToUse);

            // Populate Notes from tripDetails/mock
            if (detailsToUse && detailsToUse.notes) {
                itemCount++;
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note-component';
                noteDiv.innerHTML = `<h5><i class="fas fa-sticky-note mr-2"></i>æˆ‘çš„ç¬”è®°ç‰‡æ®µ</h5><p>${detailsToUse.notes.substring(0, 120).replace(/\n/g, '<br>')}${detailsToUse.notes.length > 120 ? '...' : ''}</p>`;
                albumItemGrid.appendChild(noteDiv);
            }

            // Populate Photos (placeholders)
            if (detailsToUse && detailsToUse.photosCount > 0) {
                for (let i = 0; i < Math.min(detailsToUse.photosCount, 3); i++) {
                    itemCount++;
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'image-component';
                    imgDiv.innerHTML = `<div class="img-placeholder"><i class="fas fa-image"></i></div><p>æ—…è¡Œç…§ç‰‡ ${i + 1} ${detailsToUse === tripDetails ? '(å·²ä¸Šä¼ )' : '(ç¤ºä¾‹)'}</p>`;
                    albumItemGrid.appendChild(imgDiv);
                }
            }

            // Populate Music
            if (detailsToUse && detailsToUse.music) {
                itemCount++;
                const musicDiv = document.createElement('div');
                musicDiv.className = 'note-component !bg-purple-50 !border-purple-200 !text-purple-700';
                musicDiv.innerHTML = `<h5><i class="fas fa-music mr-2"></i>èƒŒæ™¯æ—‹å¾‹</h5><p>å½“æ—¶è†å¬: ${detailsToUse.music}</p>`;
                albumItemGrid.appendChild(musicDiv);
            }

            // Conceptual: Add a video placeholder if narrative mentioned video
            if (currentStreamedNarrativeFullText.toLowerCase().includes("è§†é¢‘è®°å½•")) {
                itemCount++;
                const videoDiv = document.createElement('div');
                videoDiv.className = 'image-component !bg-blue-50 !border-blue-200 !text-blue-700';
                videoDiv.innerHTML = `<div class="img-placeholder"><i class="fas fa-video"></i></div><p>ç›¸å…³è§†é¢‘ (æ¦‚å¿µ)</p>`;
                albumItemGrid.appendChild(videoDiv);
            }

            if (itemCount === 0) {
                albumPlaceholder.classList.remove('hidden');
                albumPlaceholder.textContent = "æš‚æ— å¤šåª’ä½“å†…å®¹å¯æ˜¾ç¤ºã€‚";
            } else {
                albumPlaceholder.classList.add('hidden');
            }
        }

        if (albumToggleButton) {
            albumToggleButton.addEventListener('click', () => {
                albumContentArea.classList.toggle('expanded');
                albumToggleButton.classList.toggle('expanded');
                const icon = albumToggleButton.querySelector('.fas');
                if (icon) {
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                }
            });
        }
        // === END: Multimedia Album Functionality ===


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            setActiveTab('tab-add-memory');
            updateHistoryPreview();

            // === START: Album Initialization on DOMContentLoaded ===
            if (albumContentArea && albumToggleButton) {
                albumContentArea.classList.remove('expanded'); // Start collapsed
                albumToggleButton.classList.remove('expanded');
                const icon = albumToggleButton.querySelector('.fas');
                if (icon) { // Set initial icon state
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
                // If results tab is somehow visible by default (e.g., during development)
                if (resultsWrapper && !resultsWrapper.classList.contains('hidden') && multimediaAlbumSection && multimediaAlbumSection.classList.contains('hidden')) {
                     // This case should be rare if default tab is 'add-memory'
                } else if (resultsWrapper && !resultsWrapper.classList.contains('hidden') && multimediaAlbumSection && !multimediaAlbumSection.classList.contains('hidden')) {
                    populateMultimediaAlbum(mockAlbumDetails); // Populate if results tab + album section are visible
                }

            } else {
                console.warn("Album toggle button or content area not found on DOMContentLoaded for initial setup.");
            }
             // === END: Album Initialization on DOMContentLoaded ===
        });

    </script>
</body>
</html>